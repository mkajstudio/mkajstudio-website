<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKAJ BOSS PANEL | Payroll & Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">

    <!-- NAVBAR -->
    <nav class="p-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 text-slate-950 w-10 h-10 rounded-xl flex items-center justify-center font-black shadow-[0_0_20px_rgba(234,179,8,0.3)]">B</div>
                <h1 class="text-xl font-black tracking-tighter text-white uppercase">MKAJ <span class="text-yellow-500">Raya Analytics</span></h1>
            </div>
            <div class="flex gap-2">
                <select id="filterTime" onchange="fetchData()" class="bg-slate-800 border-none rounded-lg px-4 py-2 text-xs font-bold outline-none focus:ring-2 focus:ring-yellow-500">
                    <option value="all">Semua Rekod</option>
                    <option value="today">Hari Ini</option>
                </select>
                <button onclick="fetchData()" class="bg-slate-800 p-2.5 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6 max-w-6xl">
        
        <!-- TOP STATS: FINANCIAL OVERVIEW -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- GROSS REVENUE -->
            <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 text-slate-800 text-8xl rotate-12 group-hover:text-yellow-500/10 transition duration-500"><i class="fas fa-wallet"></i></div>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Kutipan Kasar</p>
                <h2 id="totalRevenue" class="text-5xl font-black text-white leading-none">RM 0</h2>
                <div class="mt-4 flex items-center gap-2">
                    <span class="bg-green-500/10 text-green-500 text-[10px] px-2 py-1 rounded font-bold uppercase">Confirmed & Arrived</span>
                </div>
            </div>

            <!-- TOTAL BOOKINGS -->
            <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Slot Terjual</p>
                <h2 id="totalBookings" class="text-5xl font-black text-blue-400 leading-none">0</h2>
                <p class="text-slate-600 text-[10px] mt-4 uppercase">Jumlah Sesi Berbayar</p>
            </div>

            <!-- PROJECTED PAYROLL -->
            <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl border-l-4 border-l-rose-500">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Kos Gaji (Projected)</p>
                <h2 id="totalPayroll" class="text-5xl font-black text-rose-400 leading-none">RM 0</h2>
                <p class="text-slate-600 text-[10px] mt-4 uppercase">FT Basic + FT/PT Commission</p>
            </div>
        </div>

        <!-- SECTION: PHOTOGRAPHER PAYROLL -->
        <div class="mb-6 flex items-center justify-between">
            <h3 class="text-lg font-black uppercase tracking-widest text-white"><i class="fas fa-users mr-2 text-yellow-500"></i> Prestasi & Gaji Shooter</h3>
            <span class="text-[10px] text-slate-500 italic">* FT: RM2k + RM10/job | PT: RM20/job (Min 5)</span>
        </div>

        <div id="payrollGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            <!-- Cards akan dimasukkan via JS -->
        </div>

        <!-- THEME BREAKDOWN -->
        <div class="bg-slate-900 rounded-[2.5rem] border border-slate-800 overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-slate-800 bg-slate-800/30">
                <h3 class="font-bold uppercase tracking-widest text-sm text-white">Pecahan Jualan Ikut Tema</h3>
            </div>
            <div id="themeBreakdown" class="p-8 space-y-6">
                <!-- Progress bars via JS -->
            </div>
        </div>

    </div>

    <script src="assets/js/data.js"></script>
    <script src="assets/js/data.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwdGTp-FCzsQeZ4Kwgl-AOMA45XS-0bBu9TGiPAyUhb_LCTl-ObaHS-QEkCKKNoYv0g/exec";
        const BOSS_PIN = "9999";

        // Security Check
        if (sessionStorage.getItem("boss_auth") !== "true") {
            let p = prompt("KOD RAHSIA BOSS:");
            if(p === BOSS_PIN) sessionStorage.setItem("boss_auth", "true");
            else window.location.href = "admin.html";
        }

        async function fetchData() {
            try {
                const response = await fetch(`${GAS_URL}?action=get_data&t=${Date.now()}`);
                const data = await response.json();
                processBossData(data);
            } catch (err) { console.error("Database connection failed"); }
        }

        function processBossData(data) {
            const filter = document.getElementById('filterTime').value;
            const todayStr = new Date().toISOString().split('T')[0];

            // 1. Tapis data Confirmed/Arrived & Tarikh
            let filtered = data.filter(r => (r.Status === 'Confirmed' || r.Status === 'Arrived'));
            
            if(filter === 'today') {
                filtered = filtered.filter(r => r.Date === todayStr);
            }

            // 2. Kira Revenue Kasar
            const revenue = filtered.reduce((sum, item) => sum + (parseFloat(String(item.TotalPrice).replace(/[^0-9.]/g, '')) || 0), 0);
            
            // 3. STRUKTUR GAJI BARU (6 Shooter FT + 1 Admin FT)
            const staff = {
                "Photographer 1": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Photographer 2": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Photographer 3": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Photographer 4": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Photographer 5": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Photographer 6": { type: "FT", basic: 2000, commission: 10, jobs: 0 },
                "Admin": { type: "ADMIN", basic: 1800, commission: 0, jobs: 0 }
            };

            // Agihkan Sesi ke Shooter (Ambil dari Kolum T Google Sheets)
            filtered.forEach(item => {
                const pName = (item.Photographer || "").trim();
                if (staff[pName]) {
                    staff[pName].jobs++;
                }
            });

            let totalPayroll = 0;
            const payrollContainer = document.getElementById('payrollGrid');
            payrollContainer.innerHTML = '';

            Object.entries(staff).forEach(([name, info]) => {
                const commissionEarned = info.jobs * info.commission;
                const finalSalary = info.basic + commissionEarned;
                totalPayroll += finalSalary;

                payrollContainer.innerHTML += `
                    <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-xl relative overflow-hidden group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-black text-white text-lg leading-tight">${name}</h4>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded ${info.type === 'ADMIN' ? 'bg-blue-900 text-blue-300' : 'bg-slate-800 text-slate-400'} uppercase tracking-widest">${info.type}</span>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">Gaji + Komisen</p>
                                <p class="text-xl font-black text-yellow-500 leading-none">RM ${finalSalary.toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-6 pt-6 border-t border-slate-800">
                            <div>
                                <p class="text-[9px] font-bold text-slate-500 uppercase">Sesi Selesai</p>
                                <p class="text-sm font-bold text-white">${info.jobs}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] font-bold text-slate-500 uppercase">Komisyen (RM${info.commission}/job)</p>
                                <p class="text-sm font-bold text-emerald-400">RM ${commissionEarned.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Update Top Stats Display
            document.getElementById('totalRevenue').innerText = `RM ${revenue.toLocaleString()}`;
            document.getElementById('totalBookings').innerText = filtered.length;
            document.getElementById('totalPayroll').innerText = `RM ${totalPayroll.toLocaleString()}`;

            // 4. THEME BREAKDOWN
            renderThemeBreakdown(filtered);
        }

        function renderThemeBreakdown(data) {
            const themes = {};
            data.forEach(item => { themes[item.Theme] = (themes[item.Theme] || 0) + 1; });

            const container = document.getElementById('themeBreakdown');
            container.innerHTML = '';

            const sortedThemes = Object.entries(themes).sort((a,b) => b[1] - a[1]);

            sortedThemes.forEach(([name, count]) => {
                const percent = data.length > 0 ? ((count / data.length) * 100).toFixed(0) : 0;
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs mb-2 font-bold uppercase tracking-tighter">
                            <span class="text-slate-300">${name}</span>
                            <span class="text-white">${count} Sesi (${percent}%)</span>
                        </div>
                        <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                            <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 h-full shadow-[0_0_10px_rgba(234,179,8,0.5)]" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        window.onload = fetchData;
    </script>
</body>
</html>